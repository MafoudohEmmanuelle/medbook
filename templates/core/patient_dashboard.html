{% load static %}
<!DOCTYPE html>
<html lang="{{ request.LANGUAGE_CODE }}" data-lang="{{ request.LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord Médecin | MedBook</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="dashboard-page">

<div class="d-flex min-vh-100">

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar d-flex flex-column p-3 bg-success text-white flex-shrink-0">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="logo text-center">
                <img src="{% static 'images/logomed.jpg' %}" alt="Profile" class="rounded-circle mb-2" width="60">
                <h2>MedBook</h2>
            </div>
            <button class="btn btn-light d-lg-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item mb-1">
                <a href="{% url 'core:doctor_dashboard' %}" class="nav-link text-white active">
                    <i class="bi bi-house-door-fill me-2"></i> <span data-translate="dashboard">Tableau de bord</span>
                </a>
            </li>
            <li class="nav-item mb-1">
                <a href="{% url 'appointments:doctor_appointments' %}" class="nav-link text-white">
                    <i class="bi bi-calendar-check-fill me-2"></i> <span data-translate="my_appointments">Mes rendez-vous</span>
                </a>
            </li>
            <li class="nav-item mb-1">
                <a href="{% url 'planning:doctor_planning' %}" class="nav-link text-white">
                    <i class="bi bi-calendar3 me-2"></i> <span data-translate="planning">Mon planning</span>
                </a>
            </li>
        </ul>

        <form method="POST" action="{% url 'accounts:logout' %}" class="mt-auto">
            {% csrf_token %}
            <button class="btn btn-outline-light w-100">
                <i class="bi bi-box-arrow-right me-1"></i> Déconnexion
            </button>
        </form>
    </nav>

    <!-- Main content -->
    <main class="main-content flex-grow-1 p-4">

        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <h1>
                <span data-translate="welcome_message">Bienvenue</span>, Dr {{ doctor.user.last_name }}
            </h1>
            <div class="header-icons d-flex align-items-center gap-2">
                <button id="themeBtn" class="btn btn-light btn-sm"><i class="bi bi-moon-fill"></i></button>
                <button id="langBtn" class="btn btn-light btn-sm">EN</button>
                <a href="{% url 'accounts:profile_doctor' %}" class="btn btn-light btn-sm icon-link">
                    <i class="bi bi-person-fill"></i>
                </a>
                <button class="btn btn-light btn-sm"><i class="bi bi-question-circle-fill"></i></button>
            </div>
        </header>

        <!-- Cards -->
        <section class="cards row g-3 mb-4">
            {% with doctor.appointments.all as appts %}
            <div class="col-6 col-md-3">
                <div class="card text-white bg-purple text-center p-3">
                    <div data-translate="confirmed_appointments">RDV confirmés</div>
                    <span>{{ appts|filter:"status=confirmed"|length }}</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-dark bg-green text-center p-3">
                    <div data-translate="pending_appointments">RDV en attente</div>
                    <span>{{ appts|filter:"status=modified"|length }}</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-white bg-blue text-center p-3">
                    <div data-translate="cancelled_appointments">RDV annulés</div>
                    <span>{{ appts|filter:"status=cancelled"|length }}</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-white bg-darkgreen text-center p-3">
                    <div data-translate="completed_appointments">RDV effectués</div>
                    <span>{{ appts|filter:"status=completed"|length }}</span>
                </div>
            </div>
            {% endwith %}
        </section>

        <!-- Appointments Table -->
        <section class="table-section">
            <h2 data-translate="activity_overview">Liste des rendez-vous</h2>

            <div class="mb-2 d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary btn-sm filter-btn active" data-status="all">Tous</button>
                <button class="btn btn-outline-success btn-sm filter-btn" data-status="confirmed">Confirmés</button>
                <button class="btn btn-outline-warning btn-sm filter-btn" data-status="modified">En attente</button>
                <button class="btn btn-outline-danger btn-sm filter-btn" data-status="cancelled">Annulés</button>
                <button class="btn btn-outline-success btn-sm filter-btn" data-status="completed">Effectués</button>
            </div>

            <div class="mb-3 text-end">
                <input type="text" class="form-control w-50 d-inline-block" id="searchInput" placeholder="Rechercher un rendez-vous...">
            </div>

            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Patient</th>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Statut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentTable">
                        {% for appt in doctor.appointments.all %}
                        <tr data-status="{{ appt.status }}">
                            <td>
                                {% if appt.beneficiary %}
                                    {{ appt.beneficiary.first_name }} {{ appt.beneficiary.last_name }}
                                {% else %}
                                    {{ appt.patient.user.get_full_name }}
                                {% endif %}
                            </td>
                            <td>{{ appt.time_slot.date }}</td>
                            <td>{{ appt.time_slot.start_time|time:"H:i" }} - {{ appt.time_slot.end_time|time:"H:i" }}</td>
                            <td>{{ appt.get_status_display }}</td>
                            <td>
                                <a href="{% url 'appointments:view_appointment' appt.id %}" class="btn btn-info btn-sm">
                                    <i class="bi bi-eye-fill"></i> Voir
                                </a>
                                <a href="{% url 'appointments:edit_appointment' appt.id %}" class="btn btn-warning btn-sm">
                                    <i class="bi bi-pencil-fill"></i> Modifier
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Aucun rendez-vous</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

    </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS -->
<script src="{% static 'js/script.js' %}"></script>
<script>
    // Sidebar toggle for mobile
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    toggleBtn?.addEventListener('click', () => {
        sidebar.classList.toggle('d-none');
    });

    // Appointment filters
    const filterBtns = document.querySelectorAll('.filter-btn');
    const tableRows = document.querySelectorAll('#appointmentTable tr');

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const status = btn.getAttribute('data-status');
            tableRows.forEach(row => {
                row.style.display = (status === 'all' || row.getAttribute('data-status') === status) ? '' : 'none';
            });
        });
    });

    // Search
    const searchInput = document.getElementById('searchInput');
    searchInput?.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        tableRows.forEach(row => {
            const patientName = row.children[0].textContent.toLowerCase();
            row.style.display = patientName.includes(query) ? '' : 'none';
        });
    });
</script>

</body>
</html>
